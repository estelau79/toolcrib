<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Herramientas</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #eaf4ff, #d0e2f2);
      color: #222;
      padding: 20px;
      margin: 0;
    }

    h2 {
      background-color: #0078d4;
      color: white;
      padding: 12px 16px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    input[type="text"], input[type="file"] {
      padding: 8px;
      margin: 6px 4px;
      border-radius: 5px;
      border: 1px solid #7ca3c9;
      outline: none;
      width: 220px;
    }

    button {
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 16px;
      margin: 6px 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.2s ease;
    }

    button:hover {
      background-color: #005a9e;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    table {
      width: 100%;
      margin-top: 16px;
      border-collapse: collapse;
      background-color: #f9fcff;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }

    th {
      background-color: #cfe5fb;
      color: #003865;
      padding: 8px;
      text-align: left;
    }

    td {
      padding: 6px 8px;
      border-top: 1px solid #d7e2f1;
    }

    .error {
      color: crimson;
      font-weight: bold;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h2>üõ†Ô∏è Gesti√≥n de Herramientas</h2>

  <input type="file" id="fileInput" accept=".xlsx" />
  <label>Cargar inventario desde Excel (.xlsx)</label><br><br>

  <input type="text" id="userName" placeholder="Nombre del usuario">
  <input type="text" id="barcode" placeholder="C√≥digo de herramienta">
  <br>
  <button onclick="registrar('Retirada')">‚úÖ Registrar Retiro</button>
  <button onclick="registrar('Devuelta')">üîÑ Registrar Devoluci√≥n</button>
  <button onclick="descargarExcel()">üì• Descargar Registro</button>

  <p id="errorMessage" class="error"></p>

  <table id="tablaHistorial">
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Descripci√≥n</th>
        <th>Usuario</th>
        <th>Fecha</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let herramientasCatalogo = {};
    const historial = [];

    document.getElementById("fileInput").addEventListener("change", leerInventario);

    function leerInventario(event) {
      const archivo = event.target.files[0];
      if (!archivo) return;

      const lector = new FileReader();
      lector.onload = (e) => {
        const datos = new Uint8Array(e.target.result);
        const workbook = XLSX.read(datos, { type: "array" });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const datosHerramientas = XLSX.utils.sheet_to_json(hoja, { header: 1 });

        herramientasCatalogo = {};
        datosHerramientas.forEach((fila) => {
          if (fila[0] && fila[1]) {
            herramientasCatalogo[fila[0].toString().toUpperCase()] = fila[1];
          }
        });

        alert("‚úÖ Inventario cargado correctamente.");
      };
      lector.readAsArrayBuffer(archivo);
    }

    function registrar(estado) {
      const codigo = document.getElementById("barcode").value.trim().toUpperCase();
      const usuario = document.getElementById("userName").value.trim();
      const errorMsg = document.getElementById("errorMessage");
      errorMsg.textContent = "";

      if (!codigo || !usuario) {
        errorMsg.textContent = "‚ö†Ô∏è Ingresa nombre y c√≥digo.";
        return;
      }

      if (!(codigo in herramientasCatalogo)) {
        errorMsg.textContent = `‚ö†Ô∏è El c√≥digo ${codigo} no existe en el inventario cargado.`;
        return;
      }

      if (!confirm(`¬øConfirmas que "${herramientasCatalogo[codigo]}" ser√° marcada como ${estado}?`)) return;

      if (estado === "Devuelta") {
        for (let i = historial.length - 1; i >= 0; i--) {
          if (historial[i][0] === codigo && historial[i][4] === "Retirada") {
            historial.splice(i, 1);
            const tabla = document.querySelector("#tablaHistorial tbody");
            tabla.deleteRow(i);
            break;
          }
        }
      }

      const registro = [
        codigo,
        herramientasCatalogo[codigo],
        usuario,
        new Date().toLocaleString(),
        estado
      ];

      historial.push(registro);
      agregarAFila(registro);
      document.getElementById("barcode").value = "";
    }

    function agregarAFila(registro) {
      const fila = document.createElement("tr");
      registro.forEach(campo => {
        const td = document.createElement("td");
        td.textContent = campo;
        fila.appendChild(td);
      });
      document.querySelector("#tablaHistorial tbody").appendChild(fila);
    }

    function descargarExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([
        ["C√≥digo", "Descripci√≥n", "Usuario", "Fecha", "Estado"],
        ...historial
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "Historial");
      XLSX.writeFile(wb, "registro_herramientas.xlsx");
    }

    // üîÑ Registro autom√°tico del Service Worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js")
        .then(() => console.log("‚úÖ Service Worker registrado"))
        .catch((error) => console.error("‚ùå Error al registrar Service Worker", error));
    }
  </script>
</body>
</html>